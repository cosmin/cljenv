PATH_TO_CLJENV="$0/../"

USER_CLJENV_PATH="$HOME/.cljenv"
SYSTEM_CLJENV_PATH="/etc/cljenv/system_cljenv"
DEFAULT_CLJENV_PATH="$PATH_TO_CLJENV/default_cljenv"

function cljenv_path_for_create() {
    if [ -f "$USER_CLJENV_PATH" ] ; then
        return $USER_CLJENV_PATH
    elif [ -f "$SYSTEM_CLJENV_PATH" ] ; then
        return $SYSTEM_CLJENV_PATH
    else
        return $DEFAULT_CLJENV_PATH
    fi
}

function cljenv_create() {
    if [ -z "$1" ]; then
        TARGET="`pwd`"
    else
        TARGET="$1"
    fi

    if [ -d $TARGET ] ; then
        cp path_for_create() $TARGET
    else
        echo "ERROR: target $TARGET does not exist"
        exit 1
    fi
}

function cljenv_activate() {

    _OLD_CLJENV_NAME="$CLJENV_NAME"

    if [ -z "$1" ]; then
        ENVFILE="`pwd`/.cljenv"
        CLJENV_NAME="`pwd`"
    elif [ -z "$2" ]; then
        ENVFILE="$1/.cljenv"
        CLJENV_NAME="$1"
    else
        ENVFILE=$1
        CLJENV_NAME="$2"
    fi

    if [ -f $ENVFILE ] ; then
        _OLD_CLJENV_CLOJURE_JAVA_PATH="$CLOJURE_JAVA_PATH"
        _OLD_CLJENV_CLOJURE_JAR="$CLOJURE_JAR"
        _OLD_CLJENV_CLOJURE_CONTRIB_JAR="$CLOJURE_CONTRIB_JAR"
        _OLD_CLJENV_CLOJURE_CLASSPATH="$CLOJURE_CLASSPATH"
        _OLD_CLJENV_CLOJURE_VM_ARGS="$CLOJURE_VM_ARGS"
        _OLD_CLJENV_CLOJURE_NATIVE_LIBRARY_PATH="$CLOJURE_NATIVE_LIBRARY_PATH"
        
        . $ENVFILE
    else
        echo "ERROR: Cannot locate CLJENV definition at $ENVFILE"
        return 1
    fi

    cljenv_deactivate () {
        if [ -n "$_OLD_CLJENV_CLOJURE_JAR" ] ; then
            CLOJURE_JAR="$_OLD_CLJENV_CLOJURE_JAR"
            export CLOJURE_JAR
            unset _OLD_CLJENV_CLOJURE_JAR
        fi

        if [ -n "$_OLD_CLJENV_CLOJURE_CONTRIB_JAR" ] ; then
            CLOJURE_JAR="$_OLD_CLJENV_CLOJURE_CONTRIB_JAR"
            export CLOJURE_CONTRIB_JAR
            unset _OLD_CLJENV_CLOJURE_CONTRIB_JAR
        fi

        if [ -n "$_OLD_CLJENV_CLOJURE_JAVA_PATH" ] ; then
            CLOJURE_JAR="$_OLD_CLJENV_CLOJURE_JAVA_PATH"
            export CLOJURE_JAVA_PATH
            unset _OLD_CLJENV_CLOJURE_JAVA_PATH
        fi

        if [ -n "$_OLD_CLJENV_CLOJURE_CLASSPATH" ] ; then
            CLOJURE_JAR="$_OLD_CLJENV_CLOJURE_CLASSPATH"
            export CLOJURE_CLASSPATH
            unset _OLD_CLJENV_CLOJURE_CLASSPATH
        fi

        if [ -n "$_OLD_CLJENV_CLOJURE_VM_ARGS" ] ; then
            CLOJURE_JAR="$_OLD_CLJENV_CLOJURE_VM_ARGS"
            export CLOJURE_VM_ARGS
            unset _OLD_CLJENV_CLOJURE_VM_ARGS
        fi

        if [ -n "$_OLD_CLJENV_CLOJURE_NATIVE_LIBRARY_PATH" ] ; then
            CLOJURE_JAR="$_OLD_CLJENV_CLOJURE_NATIVE_LIBRARY_PATH"
            export CLOJURE_NATIVE_LIBRARY_PATH
            unset _OLD_CLJENV_CLOJURE_NATIVE_LIBRARY_PATH
        fi

        if [ -n "$_OLD_CLJENV_NAME" ] ; then
            CLJENV_NAME="$_OLD_CLJENV_NAME"
            export CLJENV_NAME
            unset _OLD_CLJENV_NAME
        fi

        if [ -n "$BASH" -o -n "$ZSH_VERSION" ] ; then
            hash -r
        fi

        if [ -n "$_OLD_CLJENV_PS1" ] ; then
            PS1="$_OLD_CLJENV_PS1"
            export PS1
            unset _OLD_CLJENV_PS1
        fi

        unset CLJENV
        if [ ! "$1" = "nondestructive" ] ; then
        # Self destruct!
            unset cljenv_deactivate
        fi
    }

    cljenv_deactivate nondestructive
    export CLJENV_NAME
    
    _OLD_CLJENV_PS1="$PS1"
    if [ "`basename \"$CLJENV_NAME\"`" = "__" ] ; then
    # special case for Aspen magic directories
    # see http://www.zetadev.com/software/aspen/
        PS1="[`basename \`dirname \"$CLJENV_NAME\"\``] $PS1"
    else
        PS1="(`basename \"$CLJENV_NAME\"`)$PS1"
    fi
    export PS1
    
# This should detect bash and zsh, which have a hash command that must
# be called to get it to forget past commands.  Without forgetting
# past commands the $PATH changes we made may not be respected
    
    if [ -n "$BASH" -o -n "$ZSH_VERSION" ] ; then
        hash -r
    fi

    return 0
}

function cljenv_system() {
    return cljenv_activate $SYSTEM_CLJENV_PATH system
}

function cljenv_user() {
    return cljenv_activate $USER_CLJENV_PATH user
}

function cljenv_default {
    return cljenv_activate $DEFAULT_CLJENV_PATH default
}

cljenv_activate || cljenv_user || cljenv_system || cljenv_default
